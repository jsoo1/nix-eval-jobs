use nix

export build=build
meson --reconfigure $build || meson $build

PATH_add $build/src

boost_dir=$(
nix-instantiate --eval \
    --expr 'with import ./scratch/pkgs.nix; boost.src.outPath' \
    | sed -E 's/.*(boost.*).tar.*/\1/')

curl_dir=$(
nix-instantiate --eval \
    --expr 'with import ./scratch/pkgs.nix; curl.src.outPath' \
    | sed -E 's/.*(curl.*).tar.*/\1/')

if [ ! -d scratch/$curl_dir ]
then
   tar -C ./scratch -xvf $(nix-build --no-out-link -E 'with import ./scratch/pkgs.nix; curl.src')
fi

if [ ! -d scratch/$boost_dir ]
then
   tar -C ./scratch -xvf $(nix-build --no-out-link -E 'with import ./scratch/pkgs.nix; boost.src')
fi

# You will want safe-paths somewhere with higher authority (like in ~/.config/gdb/gdbinit)
# add-auto-load-safe-path /nix/store
# add-auto-load-safe-path /home/john/projects/nix-eval-jobs/.gdbinit
cat <<EOF > .gdbinit
dir $(nix-build --no-out-link -E 'with import ./scratch/pkgs.nix; nix.debug.src')
dir scratch/$boost_dir
dir scratch/$curl_dir
set history save on
EOF
