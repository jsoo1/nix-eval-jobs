use nix

export build=build
meson --reconfigure $build || meson $build

PATH_add $build/src

boost_dir=$(
nix-build --no-out-link --attr boost.src ./scratch/pkgs.nix \
    | sed -E 's/.*(boost.*).tar.*/\1/')

curl_dir=$(
nix-build --no-out-link --attr curl.src ./scratch/pkgs.nix \
    | sed -E 's/.*(curl.*).tar.*/\1/')

if [ ! -d scratch/$curl_dir ]
then
   tar -C ./scratch -xvf $(nix-build --no-out-link --attr curl.debug.src ./scratch/pkgs.nix)
fi

if [ ! -d scratch/$boost_dir ]
then
   tar -C ./scratch -xvf $(nix-build --no-out-link --attr boost.src ./scratch/pkgs.nix)
fi

curl_debug_out=$(nix-build --no-out-link --attr curl.debug ./scratch/pkgs.nix)
nix_debug_out=$(nix-build --no-out-link --attr nix.debug ./scratch/pkgs.nix)

# Extra special magic sauce. Use it!
export NIX_DEBUG_INFO_DIRS="$curl_debug_out/lib/debug:$nix_debug_out/lib/debug${NIX_DEBUG_INFO_DIRS:+:$NIX_DEBUG_INFO_DIRS}"

# You will want safe-paths somewhere with higher authority (like in ~/.config/gdb/gdbinit)
# add-auto-load-safe-path /nix/store
# add-auto-load-safe-path /home/john/projects/nix-eval-jobs/.gdbinit
cat <<EOF > .gdbinit
dir $(nix-build --no-out-link --attr nix.debug.src ./scratch/pkgs.nix)
dir scratch/$boost_dir
dir scratch/$curl_dir
set history save on
EOF
